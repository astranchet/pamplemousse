#!/usr/bin/env php
<?php
require_once __DIR__ . "/../vendor/autoload.php";
$app = require_once __DIR__.'/../src/app.php';

# Sync filesystem photos with database
$iterator = new RecursiveDirectoryIterator($app['photos']->getUploadDir(), FilesystemIterator::SKIP_DOTS);
foreach ($iterator as $imagePath) {
    $photo = $app['photos']->findFromFilename(basename($imagePath));
    if ($photo) {
        echo $photo->url . PHP_EOL;
        foreach ($app['config']['thumbnails']['size'] as $size) {
            list($width, $height) = split('x', $size);
            $app['photos']->getThumbnail($photo, $width, $height);
        }
    } else {
        # TODO : add file to db
        echo "Could not find $imagePath in db". PHP_EOL;
    }
}

# TODO : remove useless thumbnails


# Remove obsolete images from db
$photos = $app['photos']->getAll();
foreach ($photos as $photo) {
    if (!$photo->exists()) {
        $app['photos']->delete($photo);
    }
}
